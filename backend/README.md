# Lambda GraphQL

AWS Lambda + API Gateway for deploying GraphQL endpoints using the [SAM framework](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html).
This is basically the [SAM hello world app](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-getting-started-hello-world.html)
adapted for GraphQL endpoints.

- [SAM_README.md](./SAM_README.md) autogenerated README from SAM framework
- [template.yaml](./template.yaml) defines infrastructure for SAM framework
- [app.py](./app.py) ASGI app to make GraphQL development easier
- [src/](./src/) code to be included in Lambda functions
- [tests/](./tests/) pytest suite

- **API Gateway** https://ha0eqjwykj.execute-api.eu-central-1.amazonaws.com/stage/graphql/
- **Cloudfront** d2ysezm77udmsh.cloudfront.net

## tldr;

```
# local app
PYTHONPATH=./src uvicorn app:app --reload

# run tests
PYTHONPATH=./src pytest tests

# redeploy
sam build && sam deploy --config-file samconfig.toml
```

## Init

Initially run guided deployment with admin rights to get bucket and API ids.
Then use created samconfig.toml for future deployments.
Note URLs from `sam deploy` STDOUT.

```
sam validate
sam build
sam deploy --guided
```

An URL is generated from the AWS region and some id.
To fix the backend URL and let it go through cloudflare:

1. Create AWS certificate (ACM) for `*.prevailing-winds` in us-1 (even if used for another region).
2. Add custom domain definition with `backend.prevailing-winds.de` to [template.yaml](./template.yaml) and deploy.
3. In AWS console > API Gateway > _prevailing-winds_ > _Custom Domains_ check target domain (`*.cloudfront.net`).
4. In cloudflare > DNS > add CNAME `backend` with value of that target domain.
5. Test https://backend.prevailing-winds.de/graphql/

## Local App

There is an ASGI app in [app.py](./app.py) for easier GraphQL development locally.

```
# start app
PYTHONPATH=./src uvicorn app:app --reload
```

Additionally, point your vscode to the env file
for the linters to work and make your integrated terminal use it as well:

```
{
    "python.envFile": "${workspaceFolder}/dev.env",
    "terminal.integrated.shellArgs.linux": ["-c", "export `cat dev.env`; bash"]
}
```

## Tests

Run pytests in [tests/](./tests/).
Changes in yaml file can be checked with `sam validate`, but this needs AWS admin role credentials.

```
# pytests
PYTHONPATH=./src pytest tests

# check yaml (only works with aws admin role)
sam validate
```
